<!doctype html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Gauge Test</title>
    <script src="/gauge.min.js"></script>
    <style>body {
        padding: 0;
        margin: 0;
        background: #fff
    }</style>
</head>
<body>
<button onclick="animateGauges()">Animate</button>

<hr>
<canvas id="rpm-gauge"></canvas>

<div class="stats">
    <div>Min: <span id="minRPM">0</span></div>
    <div>Max: <span id="maxRPM">0</span></div>
    <div>Avg: <span id="avgRPM">0</span></div>
  </div>

<script>
window.onload = function () {
    var gauge = new RadialGauge({
        renderTo: "rpm-gauge",
        width: 400,
        height: 400,
        units: 'RPM',
        title: false,
        value: 0,
        minValue: 0,
        maxValue: 8000,
        majorTicks: ['0','1000','2000','3000','4000','5000','6000','7000','8000'],
        minorTicks: 2,
        strokeTicks: false,
        highlights: [
            { from: 0,    to: 3999, color: 'rgba(0,255,0,.15)' },
            { from: 4000, to: 5999, color: 'rgba(255,255,0,.15)' },
            { from: 6000, to: 8000, color: 'rgba(255,30,0,.25)' },
        ],
        colorPlate: '#222',
        colorMajorTicks: '#f5f5f5',
        colorMinorTicks: '#ddd',
        colorTitle: '#fff',
        colorUnits: '#ccc',
        colorNumbers: '#eee',
        colorNeedle: 'rgba(240, 128, 128, 1)',
        colorNeedleEnd: 'rgba(255, 160, 122, .9)',
        valueBox: true,
        animationRule: 'bounce',
        animationDuration: 50 
    }).draw();

    var rpm = 0;

    if (!!window.EventSource) {
        var source = new EventSource('/events');
        source.onmessage = function(e) {
            let data = JSON.parse(e.data);

            gauge.value = data.rpm;
            rpm = data.rpm;

            document.getElementById("minRPM").textContent = data.min ?? 0;
            document.getElementById("maxRPM").textContent = data.max ?? 0;
            document.getElementById("avgRPM").textContent = data.avg ? data.avg.toFixed(0) : 0;
        };
    }

    var timers = [];

    window.animateGauges = function () {
        timers.push(setInterval(function () {
            gauge.value = rpm * (gauge.options.maxValue - gauge.options.minValue) + (gauge.options.minValue / 4);
        }, gauge.animation.duration + 50));
    };
};
</script>

</body>
</html>
